# StarPC Common - Agent Guide

## Overview

This repository (`github.com/aperturerobotics/common`) provides shared tooling and configuration for the StarPC ecosystem, including:

- **aptre**: Code generation tool that coordinates protoc plugins
- **protogen**: Plugin infrastructure for Go, TypeScript, C++, and Rust

## Code Generation Architecture

### Plugins

| Language | Plugin | Output |
|----------|--------|--------|
| Go | protoc-gen-go-lite | *.pb.go |
| Go | protoc-gen-go-starpc | *_srpc.pb.go |
| TypeScript | protoc-gen-es-lite | *.pb.ts |
| TypeScript | protoc-gen-es-starpc | *_srpc.pb.ts |
| C++ | protoc-gen-starpc-cpp | *_srpc.pb.hpp, *_srpc.pb.cpp |
| Rust | protoc-gen-starpc-rust | *_srpc.pb.rs |

### Key Files

- `protogen/plugins.go` - Plugin discovery and configuration
- `tools/deps.go` - Tool dependency imports (source)
- `deps.go.tools` - Embedded tool dependencies (generated by embed.bash)
- `cmd/aptre/` - Code generation CLI

### Plugin Types

The `PluginType` enum in `protogen/plugins.go` defines supported languages:

```go
const (
    PluginTypeGo PluginType = iota
    PluginTypeTypeScript
    PluginTypeCpp
    PluginTypeRust
)
```

### Plugin Discovery

Plugins are discovered by `DiscoverPlugins()` which checks:
- Go plugins: `tools/bin/` directory
- TypeScript plugins: `node_modules/.bin/` directory

### Running Code Generation

From a project using common:

```bash
npm run gen
```

This runs `embed.bash` and then `aptre generate`.

## Adding a New Plugin

1. Add the plugin type to `protogen/plugins.go`
2. Add discovery logic in `DiscoverPlugins()`
3. Add protoc args in `GetProtocArgs()`
4. Add plugin path lookup in `findPluginPath()`
5. Import the plugin in `tools/deps.go`

## Related Repositories

- `github.com/aperturerobotics/starpc` - Main RPC framework
- `github.com/aperturerobotics/protobuf-go-lite` - Lightweight protobuf for Go

## StarPC Overview

StarPC is a streaming RPC framework supporting:
- Unary RPCs
- Server streaming
- Client streaming
- Bidirectional streaming
- Nested RPC streams (rpcstream)

### Wire Format

All implementations use a simple length-prefixed framing:
- 4-byte little-endian u32 length prefix
- Protobuf-encoded Packet message

### RPC Packet Types

- `CallStart` - Initiates a new RPC call
- `CallData` - Message data in a stream
- `CallCancel` - Cancels an RPC call

### RpcStream Protocol

For nested RPC calls:
- `RpcStreamInit` - Client sends component ID
- `RpcAck` - Server acknowledges or rejects
- `RpcStreamPacket::Data` - Wraps nested RPC packets
