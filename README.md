# common

[![GoDoc Widget]][GoDoc] [![Go Report Card Widget]][Go Report Card] [![npm Widget]][npm]

> Unified protobuf code generation for Go, TypeScript, C++, and Rust with WASM.

[GoDoc]: https://godoc.org/github.com/aperturerobotics/common
[GoDoc Widget]: https://godoc.org/github.com/aperturerobotics/common?status.svg
[Go Report Card Widget]: https://goreportcard.com/badge/github.com/aperturerobotics/common
[Go Report Card]: https://goreportcard.com/report/github.com/aperturerobotics/common
[npm]: https://www.npmjs.com/package/@aptre/common
[npm Widget]: https://img.shields.io/npm/v/@aptre/common.svg

## What is this?

This repository provides the `aptre` CLI — a single tool that generates protobuf code for **four languages** without requiring you to install protoc, protoc plugins, or language-specific toolchains. Everything runs via embedded WebAssembly modules using [wazero].

[wazero]: https://github.com/tetratelabs/wazero

### Key Features

- **Zero native dependencies** — protoc and plugins run as WASM, no installation required
- **Multi-language output** — generates Go, TypeScript, C++, and Rust from a single command
- **Smart caching** — only regenerates when source files actually change
- **Go-style imports** — use familiar import paths in your `.proto` files

## Supported Languages

| Language   | Message Types | RPC Services        | Plugin                     |
| ---------- | ------------- | ------------------- | -------------------------- |
| Go         | `*.pb.go`     | `*_srpc.pb.go`      | [protobuf-go-lite]         |
| TypeScript | `*.pb.ts`     | `*_srpc.pb.ts`      | [protobuf-es-lite]         |
| C++        | `*.pb.cc/h`   | `*_srpc.pb.hpp/cpp` | Built-in protoc + [starpc] |
| Rust       | `*.pb.rs`     | `*_srpc.pb.rs`      | [prost] (WASI) + [starpc]  |

[protobuf-go-lite]: https://github.com/aperturerobotics/protobuf-go-lite
[protobuf-es-lite]: https://github.com/aperturerobotics/protobuf-es-lite
[starpc]: https://github.com/aperturerobotics/starpc
[prost]: https://github.com/tokio-rs/prost

## Rust Support via WASI

The Rust code generation uses an embedded [WASI] build of `protoc-gen-prost`, meaning **you don't need Cargo, rustc, or any Rust toolchain installed** to generate `.pb.rs` files. The prost plugin runs entirely within the wazero WebAssembly runtime alongside protoc itself.

[WASI]: https://wasi.dev/

This is powered by [go-protoc-gen-prost], which embeds a ~600KB WASM binary that implements the full prost protobuf code generator.

[go-protoc-gen-prost]: https://github.com/aperturerobotics/go-protoc-gen-prost

### Example Output

Given a simple proto file:

```protobuf
syntax = "proto3";
package echo;

message EchoMsg {
  string body = 1;
}
```

The generated `echo.pb.rs`:

```rust
// @generated
// This file is @generated by prost-build.
#[derive(Clone, PartialEq, Eq, Hash, ::prost::Message)]
pub struct EchoMsg {
    #[prost(string, tag="1")]
    pub body: ::prost::alloc::string::String,
}
```

See [starpc](https://github.com/aperturerobotics/starpc) for a complete example.

## Installation

```bash
# Run directly (no install needed)
go run github.com/aperturerobotics/common/cmd/aptre@latest generate

# Or install globally
go install github.com/aperturerobotics/common/cmd/aptre@latest
```

## Quick Start

1. **Set up your project** with Go and optionally TypeScript:

```bash
# Initialize Go module
go mod init github.com/yourorg/yourproject
```

2. **Create a proto file** using Go-style imports:

```protobuf
syntax = "proto3";
package example;

// Import .proto files using Go-style import paths
import "github.com/aperturerobotics/controllerbus/controller/controller.proto";

message GetBusInfoResponse {
  repeated controller.Info running_controllers = 1;
}
```

3. **Generate code**:

```bash
# Stage files for git (required for discovery)
git add -A

# Generate all languages
go run github.com/aperturerobotics/common/cmd/aptre@latest generate

# Or with verbose output
go run github.com/aperturerobotics/common/cmd/aptre@latest generate --verbose
```

## CLI Commands

| Command            | Description                                        |
| ------------------ | -------------------------------------------------- |
| `generate`         | Generate protobuf code (Go, TypeScript, C++, Rust) |
| `generate --force` | Regenerate all files, ignoring cache               |
| `clean`            | Remove generated files and cache                   |
| `deps`             | Ensure all dependencies are installed              |
| `lint`             | Run golangci-lint                                  |
| `fix`              | Run golangci-lint with --fix                       |
| `test`             | Run go test                                        |
| `test --browser`   | Run tests in browser with WebAssembly              |
| `format`           | Format Go code with gofumpt                        |
| `outdated`         | Show outdated dependencies                         |

## How It Works

The `aptre` tool orchestrates code generation using embedded WebAssembly:

1. **Discovery** — Finds `.proto` files matching your targets (default: `./*.proto`)
2. **Caching** — Checks `.protoc-manifest.json` to skip unchanged files
3. **Protoc (WASM)** — Runs [go-protoc-wasi] to parse protos and invoke plugins
4. **Plugins** — Native plugins for Go/TS, WASM plugin for Rust (prost)
5. **Post-processing** — Fixes imports and formats output

[go-protoc-wasi]: https://github.com/aperturerobotics/go-protoc-wasi

### Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                         aptre CLI                           │
├─────────────────────────────────────────────────────────────┤
│                     wazero runtime                          │
├─────────────┬─────────────────────────┬─────────────────────┤
│ protoc.wasm │  protoc-gen-prost.wasm  │   Native Plugins    │
│  (parsing)  │     (Rust output)       │  (Go, TS, C++)      │
└─────────────┴─────────────────────────┴─────────────────────┘
```

## C++ Support

C++ protobuf files (`.pb.cc` and `.pb.h`) are generated alongside other outputs. Add `vendor/` to your include path:

```cmake
# CMakeLists.txt
include_directories(${PROJECT_SOURCE_DIR}/vendor)
```

```cpp
#include "github.com/yourorg/yourproject/example/example.pb.h"
```

For StarPC C++ services, the `*_srpc.pb.hpp` files provide client/server stubs.

## Configuration

The generator uses sensible defaults but can be customized:

- **Targets**: Proto file patterns (default: `./*.proto`)
- **Exclude**: Patterns to skip (e.g., `vendor/**`)
- **ToolsDir**: Plugin binary location (default: `.tools`)
- **Cache**: Manifest file (default: `.protoc-manifest.json`)

## Related Projects

- [starpc](https://github.com/aperturerobotics/starpc) — Streaming RPC for Go, TypeScript, and Rust
- [protobuf-go-lite](https://github.com/aperturerobotics/protobuf-go-lite) — Lightweight Go protobuf without reflection
- [protobuf-es-lite](https://github.com/aperturerobotics/protobuf-es-lite) — Lightweight TypeScript protobuf
- [go-protoc-wasi](https://github.com/aperturerobotics/go-protoc-wasi) — Embedded protoc as WASM
- [go-protoc-gen-prost](https://github.com/aperturerobotics/go-protoc-gen-prost) — Prost plugin as WASM
- [template](https://github.com/aperturerobotics/template) — Project template using this package
- [protobuf-project](https://github.com/aperturerobotics/protobuf-project) — More extensive example

## Support

Please open a [GitHub issue] with any questions or issues.

[GitHub issue]: https://github.com/aperturerobotics/common/issues/new

... or reach out on [Matrix Chat] or [Discord].

[Matrix Chat]: https://matrix.to/#/#aperturerobotics:matrix.org
[Discord]: https://discord.gg/KJutMESRsT

## License

MIT
